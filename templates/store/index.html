{% extends 'base.html' %}
{% load cart_tags %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Basic reset and typography */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Lato', sans-serif;
        font-size: 14px;
        line-height: 1.6;
        color: #333;
    }
    
    h1, h2, h3, h4, h5, h6 {
        font-family: 'Oswald', sans-serif;
        margin-bottom: 15px;
    }
    
    h1 { font-size: 28px; }
    h2 { font-size: 24px; }
    h3 { font-size: 20px; }
    h4 { font-size: 18px; }
    h5 { font-size: 16px; }
    h6 { font-size: 12px; }
    
    a {
        color: #333;
        text-decoration: none;
    }
    
    a:hover {
        color: #1e40af;
    }
    
    .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
    }
    
    .row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -10px;
    }
    
    .col-md-9 {
        width: 100%;
        padding: 0 10px;
    }
    
    .col-md-3 {
        width: 100%;
        padding: 0 10px;
    }
    
    /* Page Title Section */
    .page-title-wrap {
        background-image: url('https://themes.g5plus.net/darna/wp-content/themes/darna/assets/images/bg-shop-title.jpg');
        background-size: cover;
        background-position: center;
        padding: 50px 0;
        text-align: center;
        color: white;
        position: relative;
    }
    
    .page-title-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
    }
    
    .page-title-inner {
        position: relative;
        z-index: 1;
    }
    
    .breadcrumbs {
        list-style: none;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 10px;
        font-size: 14px;
    }
    
    .breadcrumbs li {
        margin: 0 5px;
    }
    
    .breadcrumbs a {
        color: white;
    }
    
    /* Main Content */
    .main-content {
        padding: 30px 0;
    }
    
    /* Product Grid */
    .product-listing {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .product-item {
        border: 1px solid #eee;
        border-radius: 5px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .product-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .product-thumb {
        position: relative;
        overflow: hidden;
        height: 180px;
    }
    
    .product-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s;
    }
    
    .product-item:hover .product-thumb img {
        transform: scale(1.05);
    }
    
    .product-info {
        padding: 12px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    
    .product-name {
        font-weight: 600;
        display: block;
        margin-bottom: 8px;
        line-height: 1.3;
        min-height: 2.6em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        font-size: 16px;
    }
    
    .product-description {
        color: #666;
        font-size: 13px;
        line-height: 1.4;
        margin-bottom: 8px;
        flex-grow: 1;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        min-height: 4.2em;
    }
    
    .price {
        font-weight: 700;
        color: #1e40af;
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .price del {
        color: #999;
        font-size: 13px;
        margin-right: 5px;
    }
    
    .add-to-cart {
        background-color: #1e40af;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 3px;
        cursor: pointer;
        font-weight: 600;
        margin-top: auto;
        width: 100%;
        transition: background-color 0.3s;
        font-size: 14px;
    }
    
    .add-to-cart:hover {
        background-color: #1e3a8a;
    }
    
    /* Quantity Input */
    .quantity-inner {
        display: flex;
        align-items: center;
        margin-top: 8px;
        justify-content: center;
    }
    
    .btn-number {
        background-color: #f1f1f1;
        border: none;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 13px;
        transition: background-color 0.3s;
        border-radius: 3px;
    }
    
    .btn-number:hover {
        background-color: #ddd;
    }
    
    .btn-number:disabled {
        background-color: #e0e0e0;
        cursor: not-allowed;
    }
    
    .input-text.qty {
        width: 45px;
        text-align: center;
        border: 1px solid #ddd;
        padding: 6px;
        margin: 0 5px;
        border-radius: 3px;
    }
    
    .cart-quantity {
        font-size: 12px;
        color: #666;
        margin-left: 8px;
    }
    
    /* Sidebar */
    .sidebar {
        margin-bottom: 25px;
    }
    
    .widget {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .widget-title {
        border-bottom: 2px solid #1e40af;
        padding-bottom: 8px;
        margin-bottom: 12px;
        font-size: 16px;
    }
    
    .search-form {
        display: flex;
        align-items: center;
    }
    
    .search-form input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 3px 0 0 3px;
        font-size: 14px;
    }
    
    .search-form button {
        background-color: #1e40af;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 0 3px 3px 0;
        cursor: pointer;
    }
    
    /* Category List */
    .category-list {
        list-style: none;
    }
    
    .category-list li {
        padding: 6px 0;
        border-bottom: 1px solid #eee;
    }
    
    .category-list li:last-child {
        border-bottom: none;
    }
    
    .category-list a {
        color: #333;
        transition: color 0.3s;
        font-size: 14px;
    }
    
    .category-list a:hover {
        color: #1e40af;
    }
    
    /* Filter Section */
    .filter-section {
        margin-bottom: 15px;
    }
    
    .filter-title {
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .filter-options {
        list-style: none;
    }
    
    .filter-options li {
        padding: 4px 0;
    }
    
    .filter-options label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
    }
    
    .filter-options input {
        margin-right: 6px;
    }
    
    /* Stock Status */
    .stock-status {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-bottom: 6px;
        display: inline-block;
    }
    
    .in-stock {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .low-stock {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .out-of-stock {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    /* Product Meta */
    .product-meta {
        margin-bottom: 8px;
    }
    
    .product-category {
        font-size: 11px;
        color: #666;
        background-color: #f3f4f6;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 4px;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 5px;
        margin: 30px 0;
        padding: 15px 0;
    }
    
    .pagination a {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px 12px;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
        min-width: 38px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        color: #2c3e50;
        background: linear-gradient(to bottom, #ffffff, #f8f9fa);
        border: 1px solid #e9ecef;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 13px;
    }
    
    .pagination a:hover {
        background: linear-gradient(to bottom, #3498db, #2980b9);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3);
        border-color: #3498db;
    }
    
    .pagination a.active {
        background: linear-gradient(135deg, #1e40af, #1e3a8a);
        color: white;
        border-color: #1e3a8a;
        font-weight: 600;
        box-shadow: 0 3px 10px rgba(30, 64, 175, 0.4);
        transform: scale(1.03);
        position: relative;
    }
    
    .pagination a.active::after {
        content: '';
        position: absolute;
        bottom: -4px;
        left: 50%;
        transform: translateX(-50%);
        width: 5px;
        height: 5px;
        background: #1e40af;
        border-radius: 50%;
    }
    
    .pagination-ellipsis {
        padding: 8px 5px;
        color: #6c757d;
        font-weight: bold;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 13px;
    }
    
    /* Previous and Next buttons specific styling */
    .pagination a:first-child,
    .pagination a:last-child {
        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        border: 1px solid #dee2e6;
        font-weight: 600;
    }
    
    .pagination a:first-child:hover,
    .pagination a:last-child:hover {
        background: linear-gradient(to bottom, #1e40af, #1e3a8a);
        color: white;
        border-color: #1e3a8a;
    }
    
    .product-thumb {
        cursor: pointer;
    }
    
    .product-thumb img {
        transition: transform 0.3s ease;
    }
    
    .product-thumb:hover img {
        transform: scale(1.02);
    }
    
    /* Simple fullscreen modal */
    .fullscreen-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    #fullscreen-image {
        max-width: 95%;
        max-height: 85%;
        object-fit: contain;
    }
    
    .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        color: white;
        font-size: 24px;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
        z-index: 10000;
    }
    
    .close-btn:hover {
        background: rgba(255, 0, 0, 0.7);
    }
    
    /* Mobile-first responsive design */
    @media (min-width: 576px) {
        .product-listing {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .container {
            padding: 0 15px;
        }
        
        .row {
            margin: 0 -15px;
        }
        
        .col-md-9, .col-md-3 {
            padding: 0 15px;
        }
    }
    
    @media (min-width: 768px) {
        .col-md-9 {
            width: 75%;
        }
        
        .col-md-3 {
            width: 25%;
        }
        
        .product-listing {
            grid-template-columns: repeat(3, 1fr);
        }
        
        h1 { font-size: 32px; }
        h3 { font-size: 22px; }
        
        .page-title-wrap {
            padding: 80px 0;
        }
        
        .main-content {
            padding: 50px 0;
        }
        
        .product-listing {
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .product-thumb {
            height: 200px;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .widget {
            padding: 20px;
            margin-bottom: 30px;
        }
    }
    
    @media (min-width: 992px) {
        .product-listing {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    
    /* Mobile-specific adjustments */
    @media (max-width: 575px) {
        .breadcrumbs {
            font-size: 12px;
        }
        
        .breadcrumbs li {
            margin: 0 3px;
        }
        
        .product-name {
            font-size: 15px;
        }
        
        .price {
            font-size: 15px;
        }
        
        .add-to-cart {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .pagination a {
            padding: 6px 10px;
            min-width: 36px;
            font-size: 12px;
        }
        
        .pagination-ellipsis {
            padding: 6px 3px;
            font-size: 12px;
        }
    }
</style>

<!-- Page Title Section -->
<section class="page-title-wrap">
    <div class="page-title-overlay"></div>
    <div class="container">
        <div class="page-title-inner">
            <h1>Products</h1>
            <ul class="breadcrumbs">
                <li><a href="{% url 'store:index' %}"><i class="fas fa-home"></i> Home</a></li>
                <li><span>Products</span></li>
            </ul>
        </div>
    </div>
</section>

<!-- Main Content -->
<main class="main-content">
    <div class="container">
        <div class="row">
            <div class="col-md-9">
                {% if query %}
                    <h3>Search results for: "{{ query }}"</h3>
                {% elif category %}
                    <h3>Category: {{ category.name }}</h3>
                {% else %}
                    <h3>All Products</h3>
                {% endif %}
                
                <!-- Product Grid -->
                <div class="product-listing">
                    {% for product in products %}
                    <div class="product-item">
                        <div class="product-thumb">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                                     onclick="openFullscreen('{{ product.image.url }}', '{{ product.name }}')">
                            {% else %}
                                <img src="https://via.placeholder.com/300x200/ffffff/cccccc?text=No+Image" 
                                     alt="{{ product.name }}">
                            {% endif %}
                        </div>
                        <div class="product-info">
                            <!-- Product Category -->
                            <span class="product-category">{{ product.category.name }}</span>
                            
                            <!-- Stock Status -->
                            {% if product.is_in_stock %}
                                {% if product.low_stock %}
                                    <span class="stock-status low-stock">Low Stock ({{ product.stock }})</span>
                                {% else %}
                                    <span class="stock-status in-stock">In Stock</span>
                                {% endif %}
                            {% else %}
                                <span class="stock-status out-of-stock">Out of Stock</span>
                            {% endif %}
                            
                            <!-- Product Name -->
                            <a href="{% url 'store:product_detail' product.slug %}" class="product-name" title="{{ product.name }}">
                                {{ product.name|truncatechars:50 }}
                            </a>
                        
                            <!-- Price -->
                            <span class="price">GH₵{{ product.price|floatformat:2 }}</span>
                            
                            <!-- Add to Cart Form -->
                            {% if product.is_in_stock %}
                            <form action="{% url 'cart:cart_add' product.id %}" method="post" class="cart-product-form" id="cart-form-{{ product.id }}">
                                {% csrf_token %}
                                <div class="quantity">
                                    <div class="quantity-inner">
                                        <button type="button" class="btn-number minus-btn" data-product-id="{{ product.id }}">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" name="quantity" value="{% with cart_quantity=cart|lookup:product.id %}{{ cart_quantity|default:1 }}{% endwith %}" min="1" max="{{ product.stock }}" class="input-text qty" id="qty-{{ product.id }}">
                                        <input type="hidden" name="override" value="True">
                                        <button type="button" class="btn-number plus-btn" data-product-id="{{ product.id }}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <span class="cart-quantity" id="cart-quantity-{{ product.id }}">
                                        (In cart: {% with cart_quantity=cart|lookup:product.id %}{{ cart_quantity|default:0 }}{% endwith %})
                                    </span>
                                </div>
                                <button type="submit" class="add-to-cart">
                                    <i class="fas fa-cart-plus"></i> Add to Cart
                                </button>
                            </form>
                            {% else %}
                                <button class="add-to-cart" disabled style="background-color: #6b7280;">
                                    <i class="fas fa-times"></i> Out of Stock
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Products Found</h4>
                        <p class="text-muted">No products match your search criteria.</p>
                        <a href="{% url 'store:product_list' %}" class="btn btn-primary">View All Products</a>
                    </div>
                    {% endfor %}
                </div>

                <!-- Simple Fullscreen Modal -->
                <div id="fullscreen-modal" class="fullscreen-modal" onclick="closeFullscreen()">
                    <span class="close-btn" onclick="closeFullscreen()">
                        <i class="fas fa-times"></i>
                    </span>
                    <img id="fullscreen-image" src="" alt="Fullscreen Product Image">
                </div>

                <!-- Pagination -->
                {% if products.has_other_pages %}
                <div class="pagination">
                    {% if products.has_previous %}
                        <a href="?page={{ products.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">Previous</a>
                    {% endif %}
                    
                    {% comment %} Calculate the page range to display {% endcomment %}
                    {% with current_page=products.number total_pages=products.paginator.num_pages %}
                        {% comment %} Determine the start and end of the page range {% endcomment %}
                        {% if total_pages <= 10 %}
                            {% comment %} Show all pages if there are 10 or fewer {% endcomment %}
                            {% for num in products.paginator.page_range %}
                                {% if products.number == num %}
                                    <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="active">{{ num }}</a>
                                {% else %}
                                    <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">{{ num }}</a>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% comment %} Show only 10 pages at a time {% endcomment %}
                            {% comment %} Calculate which 10 pages to show {% endcomment %}
                            {% if current_page <= 6 %}
                                {% comment %} Show pages 1-10 {% endcomment %}
                                {% for num in products.paginator.page_range %}
                                    {% if num <= 10 %}
                                        {% if products.number == num %}
                                            <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="active">{{ num }}</a>
                                        {% else %}
                                            <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">{{ num }}</a>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% if total_pages > 10 %}
                                    <span class="pagination-ellipsis">...</span>
                                    <a href="?page={{ total_pages }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">{{ total_pages }}</a>
                                {% endif %}
                            {% elif current_page >= total_pages|add:"-5" %}
                                {% comment %} Show last 10 pages {% endcomment %}
                                <a href="?page=1{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">1</a>
                                <span class="pagination-ellipsis">...</span>
                                {% for num in products.paginator.page_range %}
                                    {% if num >= total_pages|add:"-9" %}
                                        {% if products.number == num %}
                                            <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="active">{{ num }}</a>
                                        {% else %}
                                            <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">{{ num }}</a>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {% comment %} Show pages around current page {% endcomment %}
                                <a href="?page=1{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">1</a>
                                <span class="pagination-ellipsis">...</span>
                                {% for num in products.paginator.page_range %}
                                    {% if num >= current_page|add:"-4" and num <= current_page|add:"5" %}
                                        {% if products.number == num %}
                                            <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}" class="active">{{ num }}</a>
                                        {% else %}
                                            <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">{{ num }}</a>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <span class="pagination-ellipsis">...</span>
                                <a href="?page={{ total_pages }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">{{ total_pages }}</a>
                            {% endif %}
                        {% endif %}
                    {% endwith %}
                    
                    {% if products.has_next %}
                        <a href="?page={{ products.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category.slug }}{% endif %}">Next</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <div class="col-md-3">
                <!-- Sidebar Widgets -->
                <div class="sidebar">
                    <div class="widget">
                        <h4 class="widget-title">Search Products</h4>
                        <form class="search-form" action="{% url 'store:product_list' %}" method="get">
                            <input type="text" name="q" placeholder="Search Products..." value="{{ query|default_if_none:'' }}">
                            <button type="submit"><i class="fas fa-search"></i></button>
                        </form>
                    </div>
                    
                    <div class="widget">
                        <h4 class="widget-title">Product Categories</h4>
                        <ul class="category-list">
                            <li><a href="{% url 'store:product_list' %}">All Products</a></li>
                            {% for category in categories %}
                                <li><a href="{% url 'store:product_list_by_category' category.slug %}">{{ category.name }}</a></li>
                            {% empty %}
                                <li>No categories available.</li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <div class="widget">
                        <h4 class="widget-title">Top Rated Products</h4>
                        <ul class="category-list">
                            {% for product in top_rated_products %}
                                <li>
                                    <a href="{% url 'store:product_detail' product.slug %}">
                                        {{ product.name|truncatechars:30 }}
                                    </a> 
                                    <br><small>₵{{ product.price|floatformat:2 }}</small>
                                </li>
                            {% empty %}
                                <li>No top-rated products available.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
// Function to get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to calculate total items in cart from individual product quantities
function calculateTotalItems() {
    let total = 0;
    document.querySelectorAll('.cart-quantity').forEach(element => {
        const text = element.textContent;
        const match = text.match(/\(In cart: (\d+)\)/);
        if (match) {
            total += parseInt(match[1]);
        }
    });
    return total;
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing quantity controls');
    
    // Simple solution for plus/minus buttons
    document.querySelectorAll('.plus-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const input = document.getElementById(`qty-${productId}`);
            if (input) {
                let value = parseInt(input.value) || 1;
                const max = parseInt(input.getAttribute('max')) || 999;
                if (value < max) {
                    input.value = value + 1;
                    console.log(`Increased quantity for product ${productId} to ${input.value}`);
                }
            }
        });
    });
    
    document.querySelectorAll('.minus-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const input = document.getElementById(`qty-${productId}`);
            if (input) {
                let value = parseInt(input.value) || 1;
                if (value > 1) {
                    input.value = value - 1;
                    console.log(`Decreased quantity for product ${productId} to ${input.value}`);
                }
            }
        });
    });
    
    // AJAX form submission to update cart without page reload
    document.querySelectorAll('.cart-product-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            
            const productId = this.id.replace('cart-form-', '');
            const formData = new FormData(this);
            const submitButton = this.querySelector('.add-to-cart');
            const cartQuantityDisplay = document.getElementById(`cart-quantity-${productId}`);
            const cartCountDisplay = document.getElementById('cart-total-items');
            
            // Disable submit button during request
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            }
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Update individual product cart quantity
                    if (cartQuantityDisplay) {
                        cartQuantityDisplay.textContent = `(In cart: ${data.quantity})`;
                    }
                    
                    // Update total cart count
                    if (cartCountDisplay) {
                        if (data.total_items !== undefined) {
                            cartCountDisplay.textContent = data.total_items;
                        } else {
                            const totalItems = calculateTotalItems();
                            cartCountDisplay.textContent = totalItems;
                        }
                    }
                    
                    // Show success message
                    showNotification('Product added to cart successfully!', 'success');
                } else {
                    showNotification('Failed to add product to cart: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while adding product to cart', 'error');
            })
            .finally(() => {
                // Re-enable submit button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-cart-plus"></i> Add to Cart';
                }
            });
        });
    });
    
    // Notification function
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            transition: all 0.3s ease;
            max-width: 300px;
        `;
        
        if (type === 'success') {
            notification.style.backgroundColor = '#10b981';
        } else {
            notification.style.backgroundColor = '#ef4444';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
});

// If you want to add AJAX-based pagination
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for pagination links if you want AJAX loading
    document.querySelectorAll('.pagination a').forEach(link => {
        link.addEventListener('click', function(e) {
            // Optional: Add AJAX loading here if desired
            // e.preventDefault();
            // loadPage(this.href);
        });
    });
});

// Fullscreen image functionality
function openFullscreen(imageUrl, productName) {
    const modal = document.getElementById('fullscreen-modal');
    const fullscreenImage = document.getElementById('fullscreen-image');
    
    fullscreenImage.src = imageUrl;
    fullscreenImage.alt = productName;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeFullscreen() {
    const modal = document.getElementById('fullscreen-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeFullscreen();
    }
});

// Close modal when clicking outside the image
document.getElementById('fullscreen-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeFullscreen();
    }
});
</script>
{% endblock %}