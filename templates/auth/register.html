{% load static %}
{% block extra_css %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Build Kit - Your trusted supplier of high-quality building and construction materials. Cement, tools, electrical, plumbing supplies and more.">
    <meta name="keywords" content="building materials, construction supplies, cement, steel, tools, electrical, plumbing">
    <meta name="author" content="Build Kit">
    <meta property="og:title" content="Build Kit - Home of Quality Building Materials">
    <meta property="og:description" content="Your trusted supplier of high-quality building and construction materials.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://buildkit.shop">
    <meta property="og:image" content="img/logo.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="theme-color" content="#ffb600">
    <link rel="canonical" href="https://buildkit.shop">
    <link rel="shortcut icon" href="{% static 'img/logo.png'%}">
    <title>BuildKit Construction - Registration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="{% static 'css/auth.css' %}" rel="stylesheet">
{% endblock %}
{% block content %}
{% if verification_form %}
    <!-- Verification Screen -->
    <div class="register-container verification-container" id="verificationContainer">
        <h2>Verify Phone Number</h2>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}" role="alert">
                    {{ message }}
                    <!-- Show code if Firebase failed and we're using fallback -->
                    {% if "Verification code:" in message.message %}
                        <div class="mt-2 p-2 bg-light border rounded">
                            <small>Can't find the SMS? Use this code:</small>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <code class="fs-5">{{ message.message|slice:"21:" }}</code>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ message.message|slice:"21:" }}')">
                                    Copy
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-mobile-alt"></i>
                We've sent a verification code to your phone via SMS.
            </div>
        {% endif %}
        
        <form id="verificationForm" method="post">
            {% csrf_token %}
            <input type="hidden" id="firebaseSessionInfo" value="{{ request.session.firebase_session_info|default:'' }}">
            
            <div class="form-group">
                <label for="verificationCode" class="form-label">6-Digit Verification Code</label>
                <input type="text" class="form-control verification-code-input" id="verificationCode" 
                       name="{{ verification_form.verification_code.name }}" 
                       placeholder="Enter 6-digit code" 
                       required 
                       maxlength="6"
                       pattern="[0-9]{6}"
                       autocomplete="one-time-code"
                       value="{{ verification_form.verification_code.value|default:'' }}">
                {% if verification_form.verification_code.errors %}
                    <div class="error" id="codeError">{{ verification_form.verification_code.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="verifyButton">
                    Verify & Create Account
                </button>
            </div>
            
            <div class="mt-3 text-center">
                <p class="text-muted">
                    <small>Code expires in 10 minutes</small>
                </p>
                <p class="text-secondary">
    <a href="#" id="resendCode" onclick="resendCode()">Resend Code</a> | 
    <a href="{% url 'store:register' %}?clear_session=true" id="backToRegister">Back to Registration</a>
</p>
            </div>
        </form>
    </div>

{% else %}
    <!-- Registration Screen -->
    <div class="register-container" id="registerContainer">
        <h2>Create Account</h2>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        
        <form id="registerForm" method="post">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="fullName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="fullName" 
                       name="{{ form.full_name.name }}" 
                       placeholder="Enter your full name" 
                       required 
                       value="{{ form.full_name.value|default:'' }}">
                {% if form.full_name.errors %}
                    <div class="error">{{ form.full_name.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" 
                       name="{{ form.email.name }}" 
                       placeholder="Enter your email" 
                       required 
                       value="{{ form.email.value|default:'' }}">
                {% if form.email.errors %}
                    <div class="error">{{ form.email.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" 
                       name="{{ form.username.name }}" 
                       placeholder="Choose a username" 
                       required 
                       value="{{ form.username.value|default:'' }}">
                {% if form.username.errors %}
                    <div class="error">{{ form.username.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" 
                       name="{{ form.password1.name }}" 
                       placeholder="Create a password" 
                       required>
                {% if form.password1.errors %}
                    <div class="error" id="passwordError">{{ form.password1.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirmPassword" 
                       name="{{ form.password2.name }}" 
                       placeholder="Confirm your password" 
                       required>
                {% if form.password2.errors %}
                    <div class="error" id="passwordError">{{ form.password2.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="phoneNumber" class="form-label">Phone Number</label>
                <div class="input-group">
                    <span class="input-group-text">+233</span>
                    <input type="tel" class="form-control" id="phoneNumber" 
                           name="{{ form.phone_number.name }}" 
                           placeholder="Phone number (e.g., 501234567)" 
                           pattern="[0-9]{9}"
                           required 
                           value="{{ form.phone_number.value|default:'' }}">
                </div>
                <div class="form-text">Enter your Ghana phone number without the country code</div>
                {% if form.phone_number.errors %}
                    <div class="error" id="phoneError">{{ form.phone_number.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="sendCodeButton">
                    Send Verification Code
                </button>
            </div>
            
            <div class="mt-3 text-center">
                <p class="text-secondary">Already have an account? <a href="{% url 'store:login' %}">Login here</a></p>
            </div>
        </form>
    </div>
{% endif %}

<!-- Firebase App and Analytics SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<!-- JavaScript for Real Firebase Implementation -->
<script>
 // Firebase Real Implementation
const firebaseConfig = {
    apiKey: "{{ FIREBASE_WEB_API_KEY }}",
    authDomain: "{{ FIREBASE_AUTH_DOMAIN }}",
    projectId: "{{ FIREBASE_PROJECT_ID }}",
    storageBucket: "{{ FIREBASE_STORAGE_BUCKET }}",
    messagingSenderId: "{{ FIREBASE_MESSAGING_SENDER_ID }}",
    appId: "{{ FIREBASE_APP_ID }}"
};
document.addEventListener('DOMContentLoaded', function() {
    console.log("Firebase Config Check:");
    console.log("API Key:", "{{ FIREBASE_WEB_API_KEY }}" ? "✅ Set" : "❌ Missing");
    console.log("Auth Domain:", "{{ FIREBASE_AUTH_DOMAIN }}" ? "✅ Set" : "❌ Missing");
    console.log("Project ID:", "{{ FIREBASE_PROJECT_ID }}" ? "✅ Set" : "❌ Missing");
    console.log("App ID:", "{{ FIREBASE_APP_ID }}" ? "✅ Set" : "❌ Missing");
    
    // Test Firebase initialization
    try {
        if (firebaseApp) {
            console.log("✅ Firebase initialized successfully");
        } else {
            console.log("❌ Firebase not initialized");
        }
    } catch (e) {
        console.log("❌ Firebase error:", e);
    }
});

// Initialize Firebase
let firebaseApp;
let recaptchaVerifier;
let confirmationResult;

try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    console.log("Firebase initialized successfully");
} catch (error) {
    console.error("Firebase initialization error:", error);
}

// Setup reCAPTCHA verifier
function setupRecaptcha() {
    if (!firebaseApp) {
        console.error("Firebase not initialized");
        return false;
    }
    
    try {
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('sendCodeButton', {
            'size': 'invisible',
            'callback': (response) => {
                console.log("reCAPTCHA solved automatically");
            },
            'expired-callback': () => {
                console.log("reCAPTCHA expired");
                showToast('Security check expired. Please try again.', 'error');
            }
        });
        return true;
    } catch (error) {
        console.error("reCAPTCHA setup error:", error);
        return false;
    }
}

// Send verification code via Firebase
async function sendVerificationCode(phoneNumber) {
    if (!firebaseApp) {
        throw new Error('Firebase not configured');
    }

    if (!recaptchaVerifier) {
        if (!setupRecaptcha()) {
            throw new Error('Failed to setup security check');
        }
    }

    try {
        console.log("Sending verification code to:", phoneNumber);
        
        confirmationResult = await firebase.auth().signInWithPhoneNumber(phoneNumber, recaptchaVerifier);
        console.log("SMS sent successfully");
        return true;
    } catch (error) {
        console.error("Error sending SMS:", error);
        
        // Handle specific Firebase errors
        if (error.code === 'auth/invalid-phone-number') {
            throw new Error('Invalid phone number format');
        } else if (error.code === 'auth/quota-exceeded') {
            throw new Error('SMS quota exceeded. Please try again later.');
        } else if (error.code === 'auth/too-many-requests') {
            throw new Error('Too many attempts. Please try again later.');
        } else {
            throw new Error('Failed to send SMS: ' + error.message);
        }
    }
}

// Verify the code entered by user
async function verifyCode(verificationCode) {
    if (!confirmationResult) {
        throw new Error('No verification in progress. Please request a new code.');
    }

    try {
        const result = await confirmationResult.confirm(verificationCode);
        console.log("Phone verification successful:", result);
        return result;
    } catch (error) {
        console.error("Error verifying code:", error);
        
        if (error.code === 'auth/invalid-verification-code') {
            throw new Error('Invalid verification code');
        } else if (error.code === 'auth/code-expired') {
            throw new Error('Verification code expired. Please request a new one.');
        } else {
            throw new Error('Verification failed: ' + error.message);
        }
    }
}

// Modified form submission for real Firebase
document.addEventListener('DOMContentLoaded', function() {
    const registerForm = document.getElementById('registerForm');
    const verificationForm = document.getElementById('verificationForm');
    
    // Auto-format phone number
    const phoneInput = document.getElementById('phoneNumber');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            if (this.value.length > 9) {
                this.value = this.value.slice(0, 9);
            }
        });
    }
    
    // Auto-format verification code
    const verificationInput = document.getElementById('verificationCode');
    if (verificationInput) {
        verificationInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            if (this.value.length > 6) {
                this.value = this.value.slice(0, 6);
            }
        });
        
        setTimeout(() => {
            verificationInput.focus();
        }, 500);
    }

    // Handle registration form submission
    if (registerForm) {
        let isSubmitting = false;
        
        registerForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            isSubmitting = true;
            
            const button = document.getElementById('sendCodeButton');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Sending Code...';
                button.disabled = true;
                
                // Get phone number and format it
                const phoneNumber = '+233' + document.getElementById('phoneNumber').value;
                console.log("Attempting to send SMS to:", phoneNumber);
                
                // Send verification code via Firebase
                const success = await sendVerificationCode(phoneNumber);
                
                if (success) {
                    console.log("SMS sent successfully, submitting form...");
                    
                    // Store Firebase confirmation in hidden field
                    const firebaseField = document.createElement('input');
                    firebaseField.type = 'hidden';
                    firebaseField.name = 'firebase_verification_sent';
                    firebaseField.value = 'true';
                    registerForm.appendChild(firebaseField);
                    
                    // Store phone number in hidden field
                    const phoneField = document.createElement('input');
                    phoneField.type = 'hidden';
                    phoneField.name = 'formatted_phone';
                    phoneField.value = phoneNumber;
                    registerForm.appendChild(phoneField);
                    
                    // Submit the form normally
                    registerForm.submit();
                }
                
            } catch (error) {
                console.error("SMS sending failed:", error);
                showToast('Failed to send SMS: ' + error.message, 'error');
                
                // Fallback: submit form without Firebase (will use backup code)
                console.log("Using fallback mode...");
                registerForm.submit();
            } finally {
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    isSubmitting = false;
                }, 3000);
            }
        });
    }

    // Handle verification form submission
    if (verificationForm) {
        let isVerifying = false;
        
        verificationForm.addEventListener('submit', async function(e) {
            if (isVerifying) {
                e.preventDefault();
                return;
            }
            
            isVerifying = true;
            const button = document.getElementById('verifyButton');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Verifying...';
                button.disabled = true;
                
                // Try Firebase verification first
                const verificationCode = document.getElementById('verificationCode').value;
                
                if (confirmationResult && verificationCode.length === 6) {
                    try {
                        const result = await verifyCode(verificationCode);
                        console.log("Firebase verification successful");
                        
                        // Add Firebase verification success marker
                        const firebaseSuccess = document.createElement('input');
                        firebaseSuccess.type = 'hidden';
                        firebaseSuccess.name = 'firebase_verified';
                        firebaseSuccess.value = 'true';
                        verificationForm.appendChild(firebaseSuccess);
                        
                    } catch (firebaseError) {
                        console.log("Firebase verification failed, using fallback:", firebaseError);
                        // Continue with fallback verification
                    }
                }
                
                // Form will submit normally for fallback verification
                
            } catch (error) {
                console.error("Verification error:", error);
                showToast('Verification error: ' + error.message, 'error');
                e.preventDefault();
            } finally {
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    isVerifying = false;
                }, 2000);
            }
        });
    }
    
    // Enhanced resend code function
    window.resendCode = async function() {
        const resendBtn = document.getElementById('resendCode');
        if (!resendBtn || resendBtn.classList.contains('disabled')) return false;
        
        const originalText = resendBtn.innerHTML;
        resendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Sending...';
        resendBtn.classList.add('disabled');
        
        try {
            // Get phone number from session or form
            const phoneNumber = '+233{{ form.phone_number.value|default:"" }}';
            
            if (phoneNumber && phoneNumber.length === 13) {
                await sendVerificationCode(phoneNumber);
                showToast('New verification code sent!', 'success');
                startResendCountdown();
            } else {
                // Use AJAX fallback
                const response = await fetch('{% url "store:resend_verification" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('New code generated!', 'success');
                    startResendCountdown();
                } else {
                    throw new Error(data.error || 'Failed to resend code');
                }
            }
        } catch (error) {
            console.error('Resend error:', error);
            showToast('Error: ' + error.message, 'error');
        } finally {
            setTimeout(() => {
                resendBtn.innerHTML = originalText;
                if (!resendBtn.innerHTML.includes('(')) {
                    resendBtn.classList.remove('disabled');
                }
            }, 2000);
        }
        
        return false;
    };
});

// Copy code to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const btn = event.target;
        btn.textContent = 'Copied!';
        setTimeout(() => {
            btn.textContent = 'Copy';
        }, 2000);
    });
}

// Show toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : (type === 'success' ? 'success' : 'info')} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Countdown timer for resend
let countdown = 60;
let countdownInterval;

function startResendCountdown() {
    const resendBtn = document.getElementById('resendCode');
    if (!resendBtn) return;

    resendBtn.classList.add('disabled');
    countdown = 60;

    if (countdownInterval) {
        clearInterval(countdownInterval);
    }

    countdownInterval = setInterval(() => {
        resendBtn.innerHTML = `Resend Code (${countdown}s)`;
        countdown--;

        if (countdown < 0) {
            clearInterval(countdownInterval);
            resendBtn.innerHTML = 'Resend Code';
            resendBtn.classList.remove('disabled');
        }
    }, 1000);
}

// Start countdown on verification page load
{% if verification_form %}
document.addEventListener('DOMContentLoaded', function() {
    startResendCountdown();
});
{% endif %}

    // Password strength indicator (optional enhancement)
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('password');
        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                const strengthIndicator = document.getElementById('passwordStrength');
                if (!strengthIndicator) return;
                
                const password = this.value;
                let strength = 0;
                
                if (password.length >= 8) strength++;
                if (password.match(/[a-z]/)) strength++;
                if (password.match(/[A-Z]/)) strength++;
                if (password.match(/[0-9]/)) strength++;
                if (password.match(/[^a-zA-Z0-9]/)) strength++;
                
                const strengthText = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'][strength] || 'Very Weak';
                const strengthClass = ['danger', 'warning', 'info', 'success', 'success'][strength] || 'danger';
                
                strengthIndicator.textContent = `Password Strength: ${strengthText}`;
                strengthIndicator.className = `form-text text-${strengthClass}`;
            });
        }
    });
</script>
<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<!-- Font Awesome for icons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
{% endblock %}