{% load static %}
{% block extra_css %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Build Kit - Your trusted supplier of high-quality building and construction materials. Cement, tools, electrical, plumbing supplies and more.">
    <meta name="keywords" content="building materials, construction supplies, cement, steel, tools, electrical, plumbing">
    <meta name="author" content="Build Kit">
    <meta property="og:title" content="Build Kit - Home of Quality Building Materials">
    <meta property="og:description" content="Your trusted supplier of high-quality building and construction materials.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://buildkit.shop">
    <meta property="og:image" content="img/logo.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="theme-color" content="#ffb600">
    <link rel="canonical" href="https://buildkit.shop">
    <link rel="shortcut icon" href="{% static 'img/logo.png'%}">
    <title>BuildKit Construction - Registration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="{% static 'css/auth.css' %}" rel="stylesheet">
{% endblock %}
{% block content %}
{% if verification_form %}
    <!-- Verification Screen -->
    <div class="register-container verification-container" id="verificationContainer">
        <h2>Verify Phone Number</h2>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}" role="alert">
                    {{ message }}
                    <!-- Show code if Firebase failed and we're using fallback -->
                    {% if "Verification code:" in message.message %}
                        <div class="mt-2 p-2 bg-light border rounded">
                            <small>Can't find the SMS? Use this code:</small>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <code class="fs-5">{{ message.message|slice:"21:" }}</code>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ message.message|slice:"21:" }}')">
                                    Copy
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-mobile-alt"></i>
                We've sent a verification code to your phone via SMS.
            </div>
        {% endif %}
        
        <form id="verificationForm" method="post">
            {% csrf_token %}
            <input type="hidden" id="firebaseSessionInfo" value="{{ request.session.firebase_session_info|default:'' }}">
            
            <div class="form-group">
                <label for="verificationCode" class="form-label">6-Digit Verification Code</label>
                <input type="text" class="form-control verification-code-input" id="verificationCode" 
                       name="{{ verification_form.verification_code.name }}" 
                       placeholder="Enter 6-digit code" 
                       required 
                       maxlength="6"
                       pattern="[0-9]{6}"
                       autocomplete="one-time-code"
                       value="{{ verification_form.verification_code.value|default:'' }}">
                {% if verification_form.verification_code.errors %}
                    <div class="error" id="codeError">{{ verification_form.verification_code.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="verifyButton">
                    Verify & Create Account
                </button>
            </div>
            
            <div class="mt-3 text-center">
                <p class="text-muted">
                    <small>Code expires in 10 minutes</small>
                </p>
                <p class="text-secondary">
    <a href="#" id="resendCode" onclick="resendCode()">Resend Code</a> | 
    <a href="{% url 'store:register' %}?clear_session=true" id="backToRegister">Back to Registration</a>
</p>
            </div>
        </form>
    </div>

{% else %}
    <!-- Registration Screen -->
    <div class="register-container" id="registerContainer">
        <h2>Create Account</h2>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        
        <form id="registerForm" method="post">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="fullName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="fullName" 
                       name="{{ form.full_name.name }}" 
                       placeholder="Enter your full name" 
                       required 
                       value="{{ form.full_name.value|default:'' }}">
                {% if form.full_name.errors %}
                    <div class="error">{{ form.full_name.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" 
                       name="{{ form.email.name }}" 
                       placeholder="Enter your email" 
                       required 
                       value="{{ form.email.value|default:'' }}">
                {% if form.email.errors %}
                    <div class="error">{{ form.email.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" 
                       name="{{ form.username.name }}" 
                       placeholder="Choose a username" 
                       required 
                       value="{{ form.username.value|default:'' }}">
                {% if form.username.errors %}
                    <div class="error">{{ form.username.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" 
                       name="{{ form.password1.name }}" 
                       placeholder="Create a password" 
                       required>
                {% if form.password1.errors %}
                    <div class="error" id="passwordError">{{ form.password1.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirmPassword" 
                       name="{{ form.password2.name }}" 
                       placeholder="Confirm your password" 
                       required>
                {% if form.password2.errors %}
                    <div class="error" id="passwordError">{{ form.password2.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="phoneNumber" class="form-label">Phone Number</label>
                <div class="input-group">
                    <span class="input-group-text">+233</span>
                    <input type="tel" class="form-control" id="phoneNumber" 
                           name="{{ form.phone_number.name }}" 
                           placeholder="Phone number (e.g., 501234567)" 
                           pattern="[0-9]{9}"
                           required 
                           value="{{ form.phone_number.value|default:'' }}">
                </div>
                <div class="form-text">Enter your Ghana phone number without the country code</div>
                {% if form.phone_number.errors %}
                    <div class="error" id="phoneError">{{ form.phone_number.errors.as_text }}</div>
                {% endif %}
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="sendCodeButton">
                    Send Verification Code
                </button>
            </div>
            
            <div class="mt-3 text-center">
                <p class="text-secondary">Already have an account? <a href="{% url 'store:login' %}">Login here</a></p>
            </div>
        </form>
    </div>
{% endif %}

<!-- Firebase App and Analytics SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<!-- JavaScript for Real Firebase Implementation -->
<script>
    // Firebase configuration - Use actual values or safe fallback
    const firebaseConfig = {
        apiKey: "{{ FIREBASE_WEB_API_KEY|default:'demo-key' }}",
        authDomain: "{{ FIREBASE_AUTH_DOMAIN|default:'demo.firebaseapp.com' }}",
        projectId: "{{ FIREBASE_PROJECT_ID|default:'demo-project' }}",
        appId: "{{ FIREBASE_APP_ID|default:'demo-app-id' }}"
    };

    // Initialize Firebase only if config values are not demo
    let firebaseApp;
    let recaptchaVerifier;
    let confirmationResult;

    // Check if we have real Firebase config (not demo values)
    const hasRealFirebaseConfig = firebaseConfig.apiKey && 
                                 firebaseConfig.apiKey !== 'demo-key' && 
                                 firebaseConfig.apiKey !== '';

    if (hasRealFirebaseConfig) {
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.log("Firebase initialization error:", error);
        }
    } else {
        console.log("Firebase not configured - using fallback mode");
    }

    // Copy code to clipboard
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        });
    }
    
    // Auto-format phone number
    document.addEventListener('DOMContentLoaded', function() {
        const phoneInput = document.getElementById('phoneNumber');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                // Remove any non-digit characters
                this.value = this.value.replace(/\D/g, '');
                
                // Limit to 9 digits for Ghana numbers
                if (this.value.length > 9) {
                    this.value = this.value.slice(0, 9);
                }
            });
        }
        
        // Auto-advance OTP input (but don't auto-submit to prevent double submission)
        const verificationInput = document.getElementById('verificationCode');
        if (verificationInput) {
            verificationInput.addEventListener('input', function(e) {
                // Remove any non-digit characters
                this.value = this.value.replace(/\D/g, '');
                
                // Don't auto-submit - let user click the button to prevent double submission
                // Just ensure the input is clean
            });
            
            // Focus on OTP input
            setTimeout(() => {
                verificationInput.focus();
            }, 500);
        }

        // Add loading state to form submission and prevent double submission
        const registerForm = document.getElementById('registerForm');
        if (registerForm) {
            let isSubmitting = false;
            
            registerForm.addEventListener('submit', function(e) {
                if (isSubmitting) {
                    e.preventDefault();
                    return;
                }
                
                isSubmitting = true;
                const button = document.getElementById('sendCodeButton');
                if (button) {
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Sending Code...';
                    button.disabled = true;
                }
                
                // Re-enable after 5 seconds in case of error
                setTimeout(() => {
                    isSubmitting = false;
                    if (button) {
                        button.innerHTML = 'Send Verification Code';
                        button.disabled = false;
                    }
                }, 5000);
            });
        }

        const verificationForm = document.getElementById('verificationForm');
        if (verificationForm) {
            let isVerifying = false;
            
            verificationForm.addEventListener('submit', function(e) {
                if (isVerifying) {
                    e.preventDefault();
                    return;
                }
                
                isVerifying = true;
                const button = document.getElementById('verifyButton');
                if (button) {
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Verifying...';
                    button.disabled = true;
                }
                
                // Re-enable after 5 seconds in case of error
                setTimeout(() => {
                    isVerifying = false;
                    if (button) {
                        button.innerHTML = 'Verify & Create Account';
                        button.disabled = false;
                    }
                }, 5000);
            });
        }
    });
    
    // Resend code function with Firebase
    function resendCode() {
        const resendBtn = document.getElementById('resendCode');
        if (!resendBtn) return false;
        
        const originalText = resendBtn.innerHTML;
        
        resendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Sending...';
        resendBtn.classList.add('disabled');
        
        // Use AJAX to resend code
        fetch('{% url "store:resend_verification" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('Verification code sent successfully!', 'success');
                // Restart countdown
                startResendCountdown();
            } else {
                showToast('Failed to resend code: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Resend error:', error);
            showToast('Error resending code. Please try again.', 'error');
        })
        .finally(() => {
            // Reset button after 2 seconds
            setTimeout(() => {
                resendBtn.innerHTML = originalText;
                resendBtn.classList.remove('disabled');
            }, 2000);
        });
        
        return false;
    }
    
    // Show toast notification
    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : (type === 'success' ? 'success' : 'info')} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Add to page
        document.body.appendChild(toast);
        
        // Show toast
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        // Remove after hide
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    
    // Real-time password validation
    document.addEventListener('DOMContentLoaded', function() {
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');
        
        function validatePassword() {
            if (password.value !== confirmPassword.value) {
                confirmPassword.setCustomValidity("Passwords don't match");
            } else {
                confirmPassword.setCustomValidity('');
            }
        }
        
        if (password && confirmPassword) {
            password.addEventListener('input', validatePassword);
            password.addEventListener('change', validatePassword);
            confirmPassword.addEventListener('input', validatePassword);
            confirmPassword.addEventListener('keyup', validatePassword);
        }
    });

    // Countdown timer for resend
    let countdown = 60;
    let countdownInterval;

    function startResendCountdown() {
        const resendBtn = document.getElementById('resendCode');
        if (!resendBtn) return;

        resendBtn.classList.add('disabled');
        countdown = 60;

        // Clear existing interval
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        countdownInterval = setInterval(() => {
            resendBtn.innerHTML = `Resend Code (${countdown}s)`;
            countdown--;

            if (countdown < 0) {
                clearInterval(countdownInterval);
                resendBtn.innerHTML = 'Resend Code';
                resendBtn.classList.remove('disabled');
            }
        }, 1000);
    }

    // Start countdown on verification page load
    {% if verification_form %}
    document.addEventListener('DOMContentLoaded', function() {
        startResendCountdown();
    });
    {% endif %}

    // Password strength indicator (optional enhancement)
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('password');
        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                const strengthIndicator = document.getElementById('passwordStrength');
                if (!strengthIndicator) return;
                
                const password = this.value;
                let strength = 0;
                
                if (password.length >= 8) strength++;
                if (password.match(/[a-z]/)) strength++;
                if (password.match(/[A-Z]/)) strength++;
                if (password.match(/[0-9]/)) strength++;
                if (password.match(/[^a-zA-Z0-9]/)) strength++;
                
                const strengthText = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'][strength] || 'Very Weak';
                const strengthClass = ['danger', 'warning', 'info', 'success', 'success'][strength] || 'danger';
                
                strengthIndicator.textContent = `Password Strength: ${strengthText}`;
                strengthIndicator.className = `form-text text-${strengthClass}`;
            });
        }
    });
</script>
<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<!-- Font Awesome for icons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
{% endblock %}